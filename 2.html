<!DOCTYPE html>
/* thanks to wayou for his/her ideas and some codes */
<html>
  <head>
    <meta charset="utf-8" />
    <title>口语测试录音</title>
    <style>
body {font-family: Arial;}

/* Style the tab */
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons inside the tab */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 17px;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
}
</style>
  </head>
  <body>
    <h2>录音模块</h2>
    <button id="startRecordingButton">开始录音</button>
    <button id="stopRecordingButton">停止录音</button>
    <button id="playButton">查看录音</button>
    <button id="downloadButton">发送录音</button>
    <div id="info"></div>
    <hr>
    <h2>口语测试</h2>
<div class="tab">
  <button class="tablinks" onclick="openCity(event, 'jtz')">简体字</button>
  <button class="tablinks" onclick="openCity(event, 'ftz')">繁体字</button>
</div>
<div id="jtz" class="tabcontent">
  <h3>(一)请说出以下英文单词的中文意思:</h3>
  <p>1. Shell</p>
  <p>2. Green</p>
  <p>3. Postcard</p>
  <p>4. Color</p>
  <p>5. Blood</p>
  <p> </p>
  <h3>(二)先阅读一遍以下段落,并用正常语速流利地朗读一遍,(建议时长在 8 分 钟内读完):</h3>
  <p>6.你吃过花生吗?一般我们把带売的花生煮熟了以后,需要先把花生壳剥开才能吃里面的果实。很多爱吃花生的朋友,都遇到过这种情况,花生不好剥,特别是生花生,剥久了手会很痛,有时果壳不小心被捏碎了还容易卡在指甲里,所以剥花生还是需要一定技巧的。熟练的剥花生技巧能让你很快就吃到花生。</p>
  <p>7.最可悲的投资,就是做到差不多的烂尾楼。最可悲的人生,就是什么都学过, 却什么都拿不出手!为何不做到彻底呢?为何要在半成品那里停下来?为何你不能够做完整?可悲的是,你甚至只差一点儿,而你永远不知道,差一点,就是差一百,总是有那么一点偏差,结果的差别可大着呢。</p>
  <p>8.昨天隔壁宿舍的朋友来我寝室,我们两个聊了一会儿天,边聊天我边削苹果, 正削着苹果呢,就听见有人在外面喊有老鼠,好像就是隔壁宿舍的人正在逮老鼠, 我一晃神手滑了一下,削刀直接划破了我的手,流了好多血。隔壁宿舍的朋友赶紧带我去了校医院包扎伤口</p>
  <p>9.广州犯罪团伙竟然通过偷拍顾客在酒吧醉酒后衣着暴露的影片和照片,以此敲诈并勒索其钱财,有民众到公安局报案揭露该团伙的犯罪行为。警方通过天眼监控,发现其中一名男子行踪,并将其逮捕。随后涉案的8名犯罪嫌疑人均被逮捕,并被剥夺犯罪所得,涉案金额达4500万元。警方因此也提醒广大民众,日常生活中要注意避免露富,小心被不法之徒町上。</p>
  <p>10.赤眉军与绿林军两支庞大的起义军队,分别在南边与东边打败了王莽带领的军队,这个消息一传开,所有地方的农民也纷纷起义。在此同时,还有一些没落的贵族,也趁机起兵造反。</p>
  <p>11.山河令的剧情主线就是各派争夺琉璃甲壳,武林死伤无数,就为取得这琉璃甲壳钥匙,打开那武器宝库,号令天下。在第十五集中,龙渊阁主来到英雄大会, 临时变卦栽赃高盟主私吞武库。高盟主自愿削发出家,欲将盟主之位传位于张成岭。高盟主发誓要铲平鬼谷,让众人歃(shà)血为盟。周子舒温客行是“道不同,不相为谋”,周子舒愤然离去。</p>
  <p>12. </p>
  <p>老板:几位帅哥美女,我正在下载刚才拍的照片和影片。现在给你们还是等下载好了再一起给你们? </p>
  <p>顾客 1:现在看看吧,我想先看看照片儿和影片儿压压惊。</p> 
  <p>老板:好的,那给您看看。 </p>
  <p>顾客 2 对众人说:我感觉我刚才被吓到了,现在走出来的只是我的躯壳,我的灵魂还留在鬼屋里。 </p>
  <p>老板:我们这个主题算是所有系列里面最恐怖的,你们已经算很勇敢的了。</p> 
  <p>顾客 3: 你们这儿的 NPC 好敬业啊, 我看到他们那个脑壳跟舌苔上竟然都涂了颜料,真是可以,下次推荐我的朋友也来玩。 </p>
  <p>老板:那就太好了,下次几位还可以来我们店里体验体验别的主题,推荐朋友来可以打折哦。</p> 
  <p>顾客:谢谢老板啦。</p>
  <p>13. 2020东京奥运会已经落下帷幕,中国运动健儿的出色表现让人惊喜、感动并自豪,其中中国女子游泳运动员的金牌获得者全红婵也是令人印象十分深刻。想必大家对这些跳水奥运冠军的幕后故事有所关注。每一个奥运冠军的背后除了天赋、努力之外,还有一个国家的综合实力的支撑。我们既要看到跳水冠军拿到金牌时露出的微笑,也要看到他们因为长期训练而“消失的指纹”、“掉色的头发”, 同时我们更不能翘尾巴,骄傲自满,应该更加脚踏实地地发展。当综合国力稳步提高,我们在奥运会乃至其他大大小小的国际场合,都将更加自信从容。</p>
</div>
<div id="ftz" class="tabcontent">
  <h3>(一)請說出以下英文單詞的中文意思:</h3>
  <p>1. Shell</p>
  <p>2. Green</p>
  <p>3. Postcard</p>
  <p>4. Color</p>
  <p>5. Blood</p>
  <p> </p>
  <h3>(二)先閱讀一遍以下段落,並用正常語速流利地朗讀一遍,(建議時長在 8 分鐘內讀完):</h3>
  <p>6.你吃過花生嗎?一般我們把帶殻的花生煮熟了以後,需要先把花生殼剝開才能吃裏面的果實。很多愛吃花生的朋友,都遇到過這種情況,花生不好剝,特別是生花生,刽久了手會很痛,有時果殼不小心被捏碎了還容易卡在指甲裹,所以剝花生還是需要一定技巧的。熟練的剝花生技巧能讓你很快就吃到花生</p>
  <p>7.最可悲的投資,就是做到差不多的爛尾樓。最可悲的人生,就是什麽都學過, 卻什麽都拿不出手!為何不做到徹底呢?為何要在半成品那裏停下來?為何你不能夠做完整?可悲的是,你甚至只差一點兒,而你永遠不知道,差一點,就是差一百,總是有那麽一點偏差,結果的差別可大著呢。</p>
  <p>8.昨天隔壁宿舍的朋友來我寢室,我們兩個聊了一會兒天,邊聊天我邊削蘋果, 正削著蘋果呢就聽見有人在外面喊有老鼠。好像就是隔壁宿舍的人正在逮老鼠我一晃神,手滑了一下,削刀直接劃破了我的手,流了好多血。隔壁宿舍的朋友趕緊帶我去了校醫院包紮傷口。</p>
  <p>9.廣州犯罪團夥竟然通過偷拍顧客在酒吧醉酒後衣著暴露的影片和照片,以此敲詐並勒索其錢財,有民眾到公安局報案揭露該團夥的犯罪行為。警方通過天眼監控,發現其中一名男子行蹤,並將其逮捕。隨後涉案的8名犯罪嫌疑人均被逮捕,並被劍奪犯罪所得,涉案金額達4500萬元。警方因此也提醒廣大民眾,日常生活中要註意避免露富,小心被不法之徒盯上。</p>
  <p>10.赤眉軍與綠林軍兩支龐大的起義軍隊,分別在南邊與東邊打敗了王莽帶領的軍隊,這個消息一傳開,所有地方的農民也紛紛起義。在此同時,還有一些沒落的貴族,也趁機起兵造反</p>
  <p>11.山河令的劇情主線就是各派爭奪琉璃甲殼,武林死傷無數,就為取得這琉璃甲殼鑰匙,打開那武器寶庫,號令天下。在第十五集中,龍淵閣主來到英雄大會, 臨時變卦栽贓高盟主私吞武庫。高盟主自願削發出家,欲將盟主之位傳位於張成嶺。高盟主發誓要鏟平鬼谷,讓眾人歃(shà)血為盟。周子舒溫客行是“道不同,不相為謀”,周子舒憤然離去。</p>
  <p>12.</p>
  <p>老板:幾位帥哥美女,我正在下載剛才拍的照片和影片。現在給你們還是等下載好了再一起給你們?</p>
  <p>顧客1:現在看看吧,我想先看看照片兒和影片兒壓壓驚。</p>
  <p>老板:好的,那給您看看。</p>
  <p>顧客2對眾人說:我感覺我剛才被嚇到了,現在走出來的只是我的軀殼,我的靈魂還留在鬼屋裏。</p>
  <p>老板:我們這個主題算是所有系列裹面最恐怖的,你們已經算很勇敢的了。</p>
  <p>顧客3:你們這兒的NPC好敬業啊,我看到他們那個腦殼跟舌苔上竟然都塗了顔料,真是可以,下次推薦我的朋友也來玩。</p>
  <p>老板:那就太好了,下次幾位還可以來我們店裏體驗體驗別的主題,推薦朋友來可以打折哦。</p>
  <p>顧客:謝謝老板啦</p>
  <p>13. 2020東京奧運會已經落下帷幕,中國運動健兒的出色表現讓人驚喜、感動並自豪,其中中國女子遊泳運動員的金牌獲得者全紅嬋也是令人印象十分深刻。想必大家对这些跳水奥运冠军的幕后故事有所关注。每一個奥運冠軍的背後除了天赋、努力之外,還有一個國家的綜合實力的支撐。我們既要看到跳水冠軍拿到金牌時露出的微笑,也要看到他們因為長期訓練而“消失的指紋”、“掉色的頭發”,同時我們更不能翹尾巴,驕傲自滿,應該更加腳踏實地地發展。當綜合國力穩步提高,我們在奥運會乃至其他大大小小的國際場合,都將更加自信從容</p>
</div>
<script>
function openCity(evt, cityName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}
</script>
<script>
var start = 0;
var SAMPLE_RATE = 44100;
  String.prototype.toHHMMSS = function() {
    var sec_num = parseInt(this, 10); // don't forget the second param
    var hours = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - hours * 3600) / 60);
    var seconds = sec_num - hours * 3600 - minutes * 60;
    if (hours < 10) {
      hours = "0" + hours;
    }
    if (minutes < 10) {
      minutes = "0" + minutes;
    }
    if (seconds < 10) {
      seconds = "0" + seconds;
    }
    return hours + ":" + minutes + ":" + seconds;
    };
      var startRecordingButton = document.getElementById(
        "startRecordingButton"
      );
      var stopRecordingButton = document.getElementById("stopRecordingButton");
      var playButton = document.getElementById("playButton");
      var downloadButton = document.getElementById("downloadButton");

      var leftchannel = [];
      var rightchannel = [];
      var recorder = null;
      var recordingLength = 0;
      var volume = null;
      var mediaStream = null;
      var context = null;
      var blob = null;

      startRecordingButton.addEventListener("click", function() {
        start = new Date().getTime();
        // Initialize recorder
        navigator.getUserMedia =navigator.getUserMedia ||navigator.webkitGetUserMedia ||navigator.mozGetUserMedia ||navigator.msGetUserMedia;

        navigator.getUserMedia(
          {
            // audio: true
            audio: {
              sampleRate: 44100,
              channelCount: 2 // canary 中此设置未生效，始终为 2
            }
          },
          function(e) {
            console.log("user consent");

            // creates the audio context
            window.AudioContext =
              window.AudioContext || window.webkitAudioContext;
            context = new AudioContext({sampleRate: 44100});

            // creates an audio node from the microphone incoming stream
            mediaStream = context.createMediaStreamSource(e);

            // https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createScriptProcessor
            // bufferSize: the onaudioprocess event is called when the buffer is full
            var bufferSize = 2048;
            var numberOfInputChannels = 2;
            var numberOfOutputChannels = 2;
            if (context.createScriptProcessor) {
              recorder = context.createScriptProcessor(
                bufferSize,
                numberOfInputChannels,
                numberOfOutputChannels
              );
            } else {
              recorder = context.createJavaScriptNode(
                bufferSize,
                numberOfInputChannels,
                numberOfOutputChannels
              );
            }

            recorder.onaudioprocess = function(e) {
              leftchannel.push(
                new Float32Array(e.inputBuffer.getChannelData(0))
              );
              rightchannel.push(
                new Float32Array(e.inputBuffer.getChannelData(1))
              );
              recordingLength += bufferSize;
            };

            // we connect the recorder
            mediaStream.connect(recorder);
            recorder.connect(context.destination);
          },
          function(e) {
            console.error(e);
          }
        );
      });

      stopRecordingButton.addEventListener("click", function() {
          info.textContent = String((new Date().getTime()-start)/1000).toHHMMSS();
        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        // stop recording
        recorder.disconnect(context.destination);
        mediaStream.disconnect(recorder);

        // we flat the left and right channels down
        // Float32Array[] => Float32Array
        var leftBuffer = flattenArray(leftchannel, recordingLength);
        var rightBuffer = flattenArray(rightchannel, recordingLength);
        // we interleave both channels together
        // [left[0],right[0],left[1],right[1],...]
        var interleaved = interleave(leftBuffer, rightBuffer);

        // we create our wav file
        var buffer = new ArrayBuffer(44 + interleaved.length * 2);
        var view = new DataView(buffer);

        // RIFF chunk descriptor
        writeUTFBytes(view, 0, "RIFF");
        view.setUint32(4, 44 + interleaved.length * 2, true);
        writeUTFBytes(view, 8, "WAVE");
        // FMT sub-chunk
        writeUTFBytes(view, 12, "fmt ");
        view.setUint32(16, 16, true); // chunkSize
        view.setUint16(20, 1, true); // wFormatTag
        view.setUint16(22, 2, true); // wChannels: stereo (2 channels)
        view.setUint32(24, 44100, true); // dwSamplesPerSec
        view.setUint32(28, 44100 * 4, true); // dwAvgBytesPerSec
        view.setUint16(32, 4, true); // wBlockAlign
        view.setUint16(34, 16, true); // wBitsPerSample
        // data sub-chunk
        writeUTFBytes(view, 36, "data");
        view.setUint32(40, interleaved.length * 2, true);

        // write the PCM samples
        var index = 44;
        var volume = 1;
        for (var i = 0; i < interleaved.length; i++) {
          view.setInt16(index, interleaved[i] * (0x7fff * volume), true);
          index += 2;
        }

        // our final blob
        blob = new Blob([view], { type: "audio/wav" });
      });

      playButton.addEventListener("click", function() {
        if (blob == null) {
          return;
        }

        var url = window.URL.createObjectURL(blob);
        var audio = new Audio(url);
        audio.play();
      });

      downloadButton.addEventListener("click", function() {
        if (blob == null) {
          return;
        }

        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        a.href = url;
        a.download = "sample.wav";
        a.click();
        window.URL.revokeObjectURL(url);
      });

      function flattenArray(channelBuffer, recordingLength) {
        var result = new Float32Array(recordingLength);
        var offset = 0;
        for (var i = 0; i < channelBuffer.length; i++) {
          var buffer = channelBuffer[i];
          result.set(buffer, offset);
          offset += buffer.length;
        }
        return result;
      }

      function interleave(leftChannel, rightChannel) {
        var length = leftChannel.length + rightChannel.length;
        var result = new Float32Array(length);

        var inputIndex = 0;

        for (var index = 0; index < length; ) {
          result[index++] = leftChannel[inputIndex];
          result[index++] = rightChannel[inputIndex];
          inputIndex++;
        }
        return result;
      }

      function writeUTFBytes(view, offset, string) {
        for (var i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }
    </script>
  </body>
</html>
